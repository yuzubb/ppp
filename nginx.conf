worker_processes auto;

# エラーログの出力先（Renderのログで見れるようになります）
error_log /dev/stdout info;

events {
    worker_connections 1024;
}

http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;

    # ログフォーマット
    access_log /dev/stdout;

    # --- YouTubeの巨大なヘッダー（502対策） ---
    proxy_buffer_size          128k;
    proxy_buffers              4 256k;
    proxy_busy_buffers_size    256k;
    
    # タイムアウト設定（動画の重いレスポンス対策）
    proxy_read_timeout 300s;
    proxy_connect_timeout 75s;
    proxy_send_timeout 300s;

    server {
        # Renderが割り当てるポート番号をリッスン
        listen $PORT;

        location / {
            # YouTubeへ飛ばす
            proxy_pass https://www.youtube.com/;
            proxy_set_header Host www.youtube.com;

            # --- Bot制限回避用ヘッダー ---
            # 1. User-Agent (Windowsの最新Chrome)
            proxy_set_header User-Agent "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/121.0.0.0 Safari/537.36";

            # 2. Client Hints (最近のGoogle系サービスはここを厳密に見る)
            proxy_set_header Sec-Ch-Ua '"Not A(Bit:Brand";v="99", "Google Chrome";v="121", "Chromium";v="121"';
            proxy_set_header Sec-Ch-Ua-Mobile "?0";
            proxy_set_header Sec-Ch-Ua-Platform '"Windows"';

            # 3. Refererと言語設定
            proxy_set_header Referer "https://www.youtube.com/";
            proxy_set_header Accept-Language "ja,en-US;q=0.9,en;q=0.8";

            # 4. プロキシ転送設定
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            # リダイレクト時にドメインが書き換わらないようにする
            proxy_redirect off;
            
            # YouTubeのクッキーを維持するための設定
            proxy_pass_header Set-Cookie;
        }
    }
}
