worker_processes auto;
error_log /dev/stdout info;

events {
    worker_connections 1024;
}

http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;
    access_log    /dev/stdout;

    resolver 8.8.8.8 ipv6=off;

    server {
        listen $PORT;

        # タイムアウト設定
        proxy_read_timeout 60s;
        proxy_connect_timeout 60s;

        # 全てのパスに対して共通の設定
        location / {
            # リクエスト先を動的に解決（IPv6回避）
            set $upstream_endpoint mangafire.to;
            
            # 画像サーバーっぽいパスの場合は転送先を切り替え
            if ($uri ~* ^/(manga|images|covers|avatar|media|contents|data)/) {
                set $upstream_endpoint img.mangafire.to;
            }

            proxy_pass https://$upstream_endpoint;

            # --- SSL設定 ---
            proxy_ssl_server_name on;
            proxy_ssl_name $upstream_endpoint;
            proxy_ssl_protocols TLSv1.2 TLSv1.3;

            # --- ヘッダー偽装（本物のブラウザに極限まで近づける） ---
            proxy_set_header Host $upstream_endpoint;
            proxy_set_header Origin "https://mangafire.to";
            proxy_set_header Referer "https://mangafire.to/";
            
            # Render特有のプロキシヘッダーを削除（本家にバレないため）
            proxy_set_header X-Real-IP "";
            proxy_set_header X-Forwarded-For "";
            proxy_set_header X-Forwarded-Proto "";

            # --- Cookieの完全同期 ---
            # 本家が発行したCookieをあなたのドメインのものとしてブラウザに保存させる
            proxy_cookie_domain mangafire.to $host;
            proxy_cookie_domain img.mangafire.to $host;

            # --- 文字列置換（ドメインの書き換え） ---
            proxy_set_header Accept-Encoding ""; # 圧縮されると置換できないため
            sub_filter_once off;
            sub_filter_types *;
            sub_filter 'https://mangafire.to' '$scheme://$host';
            sub_filter 'https://img.mangafire.to' '$scheme://$host';
            sub_filter 'mangafire.to' '$host';
            sub_filter 'img.mangafire.to' '$host';

            # --- セキュリティ・リダイレクト対策 ---
            proxy_redirect https://mangafire.to/ /;
            proxy_redirect https://img.mangafire.to/ /;
            proxy_hide_header Content-Security-Policy;
        }
    }
}
